<!doctype html>
<html class="no-js" lang="en-us" prefix="og: http://ogp.me/ns#">

<head>
    <meta charset="utf-8">
    <title>The tweakflow data processing language | tweakflow - an embeddable expression language for the JVM</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif|Lato|Roboto|Inconsolata">
    <link rel="stylesheet" href="/tweakflow/css/normalize.css">
    <link rel="stylesheet" href="/tweakflow/css/style.css">

    <link rel="stylesheet" href="/tweakflow/js/highlight/styles/atom-one-light.css">

    <script type="text/javascript" src="/tweakflow/js/highlight/highlight.pack.js"></script>
    <script type="text/javascript">
      hljs.configure({languages: []});
      hljs.initHighlightingOnLoad();
    </script>

    <link rel="apple-touch-icon" sizes="180x180" href="/tweakflow/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/tweakflow/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/tweakflow/img/favicon-16x16.png">
    <link rel="manifest" href="/tweakflow/img/manifest.json">
    <link rel="mask-icon" href="/tweakflow/img/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/tweakflow/img/favicon.ico">
    <meta name="msapplication-config" content="/tweakflow/img/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <meta name="apple-mobile-web-app-title" content="tweakflow - an embeddable expression language for the JVM">
    <meta name="application-name" content="tweakflow - an embeddable expression language for the JVM">

</head>


<body>
    <header>
    <div class="menu">

      
      <div class="menu__logo-wrapper">
          <a href="/tweakflow" class="menu__logo"><img src="/tweakflow/img/tweakflow_logo.svg"></a>
      </div>
      
      <nav role="navigation" class="menu__items-wrapper">
        <ul class="menu__items">
            
            
            
            <li class="menu__item" >              
              <a class="menu__item-link" href="/tweakflow/getting-started.html">Getting started</a>
            </li>
            
            <li class="menu__item" >              
              <a class="menu__item-link" href="/tweakflow/reference.html">Reference</a>
            </li>
            
            <li class="menu__item" >              
              <a class="menu__item-link" href="/tweakflow/modules/std.html">Standard library</a>
            </li>
            
            <li class="menu__item" >              
              <a class="menu__item-link" href="/tweakflow/embedding.html">Embedding guide</a>
            </li>
            
            <li class="menu__item" >              
              <a class="menu__item-link" href="https://github.com/twineworks/tweakflow/">Source code</a>
            </li>
            
            
        </ul>
      </nav>
    </div>

    

</header>

    <div class="content-wrapper">
       
      <aside class="toc">
        <div class="toc-wrapper">
          <div class="scrollable-parent">
            <div class="scrollable-content">
              <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#design-principles">Design principles</a>
<ul>
<li><a href="#everything-is-a-value">Everything is a value</a></li>
<li><a href="#reproducible-calculations">Reproducible calculations</a></li>
<li><a href="#the-host-application-is-in-control">The host application is in control</a></li>
</ul></li>
<li><a href="#lexical-structure">Lexical structure</a>
<ul>
<li><a href="#keywords">Keywords</a></li>
<li><a href="#boolean-literals">Boolean literals</a></li>
<li><a href="#the-nil-literal">The nil literal</a></li>
<li><a href="#long-literals">Long literals</a></li>
<li><a href="#double-literals">Double literals</a></li>
<li><a href="#string-literals">String literals</a>
<ul>
<li><a href="#single-quoted-strings">Single-quoted strings</a></li>
<li><a href="#double-quoted-strings">Double-quoted strings</a></li>
<li><a href="#here-document-strings">Here document strings</a></li>
<li><a href="#symbol-strings">Symbol strings</a></li>
</ul></li>
<li><a href="#datetime-literals">Datetime literals</a></li>
<li><a href="#identifiers">Identifiers</a></li>
<li><a href="#end-of-statement-markers">End-of-statement markers</a></li>
<li><a href="#comments">Comments</a>
<ul>
<li><a href="#line-comments">Line comments</a></li>
<li><a href="#span-comments">Span comments</a></li>
</ul></li>
</ul></li>
<li><a href="#semantic-structure">Semantic structure</a>
<ul>
<li><a href="#data-types">Data types</a>
<ul>
<li><a href="#boolean">Boolean</a>
<ul>
<li><a href="#boolean-as-long">Boolean as long</a></li>
<li><a href="#boolean-as-double">Boolean as double</a></li>
<li><a href="#boolean-as-string">Boolean as string</a></li>
</ul></li>
<li><a href="#long">Long</a>
<ul>
<li><a href="#long-as-boolean">Long as boolean</a></li>
<li><a href="#long-as-double">Long as double</a></li>
<li><a href="#long-as-string">Long as string</a></li>
<li><a href="#long-as-datetime">Long as datetime</a></li>
</ul></li>
<li><a href="#double">Double</a>
<ul>
<li><a href="#double-as-boolean">Double as boolean</a></li>
<li><a href="#double-as-long">Double as long</a></li>
<li><a href="#double-as-string">Double as string</a></li>
</ul></li>
<li><a href="#string">String</a>
<ul>
<li><a href="#string-as-boolean">String as boolean</a></li>
<li><a href="#string-as-long">String as long</a></li>
<li><a href="#string-as-double">String as double</a></li>
<li><a href="#string-as-list">String as list</a></li>
</ul></li>
<li><a href="#datetime">Datetime</a>
<ul>
<li><a href="#datetime-as-boolean">Datetime as boolean</a></li>
<li><a href="#datetime-as-string">Datetime as string</a></li>
<li><a href="#datetime-as-dict">Datetime as dict</a></li>
</ul></li>
<li><a href="#list">List</a>
<ul>
<li><a href="#list-as-boolean">List as boolean</a></li>
<li><a href="#list-as-dict">List as dict</a></li>
</ul></li>
<li><a href="#dict">Dict</a>
<ul>
<li><a href="#dict-as-boolean">Dict as boolean</a></li>
<li><a href="#dict-as-list">Dict as list</a></li>
</ul></li>
<li><a href="#function">Function</a>
<ul>
<li><a href="#function-as-boolean">Function as boolean</a></li>
<li><a href="#functions-in-java">Functions in Java</a></li>
</ul></li>
<li><a href="#void">Void</a></li>
<li><a href="#any">Any</a></li>
</ul></li>
<li><a href="#modules">Modules</a>
<ul>
<li><a href="#global-modules">Global modules</a></li>
<li><a href="#imports">Imports</a></li>
<li><a href="#aliases">Aliases</a></li>
<li><a href="#exports">Exports</a></li>
</ul></li>
<li><a href="#libraries">Libraries</a></li>
<li><a href="#variables">Variables</a></li>
<li><a href="#annotations">Annotations</a></li>
<li><a href="#scope">Scope</a></li>
<li><a href="#expressions">Expressions</a>
<ul>
<li><a href="#nil">Nil</a></li>
<li><a href="#value-literals">Value literals</a></li>
<li><a href="#type-inspection">Type inspection</a></li>
<li><a href="#type-casts">Type casts</a></li>
<li><a href="#container-access">Container access</a>
<ul>
<li><a href="#list-access">List access</a></li>
<li><a href="#dict-access">Dict access</a></li>
<li><a href="#container-traversal">Container traversal</a></li>
</ul></li>
<li><a href="#function-calls">Function calls</a>
<ul>
<li><a href="#positional-arguments">Positional arguments</a></li>
<li><a href="#named-arguments">Named arguments</a></li>
<li><a href="#mixed-positional-and-named-arguments">Mixed positional and named arguments</a></li>
<li><a href="#splat-arguments">Splat arguments</a></li>
<li><a href="#argument-casting">Argument casting</a></li>
<li><a href="#return-value-casting">Return value casting</a></li>
</ul></li>
<li><a href="#local-variables">Local variables</a></li>
<li><a href="#conditional-evaluation">Conditional evaluation</a></li>
<li><a href="#list-comprehensions">List comprehensions</a></li>
<li><a href="#pattern-matching">Pattern Matching</a></li>
<li><a href="#errors">Errors</a>
<ul>
<li><a href="#throwing-errors">Throwing errors</a></li>
<li><a href="#catching-errors">Catching errors</a></li>
</ul></li>
<li><a href="#references">References</a>
<ul>
<li><a href="#unscoped-references">Unscoped references</a></li>
<li><a href="#library-scope-references">Library scope references</a></li>
<li><a href="#module-scope-references">Module scope references</a></li>
<li><a href="#global-scope-references">Global scope references</a></li>
<li><a href="#module-names">Module names</a></li>
</ul></li>
<li><a href="#operators">Operators</a></li>
<li><a href="#evaluation-precedence">Evaluation precedence</a></li>
</ul></li>
</ul></li>
<li><a href="#language-tools">Language tools</a>
<ul>
<li><a href="#interactive-repl">Interactive REPL</a></li>
<li><a href="#runner">Runner</a></li>
<li><a href="#metadata-extraction">Metadata extraction</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
            </div>
          </div>
        </div>
      </aside>
      
      <main class="single-content" role="main">
        

<h2 id="motivation">Motivation</h2>

<p>Tweakflow offers a way for JVM applications to evaluate user-supplied expressions in a formula-like notation. Tweakflow supports user-defined functions, libraries, and modules, to support applications in which the user-supplied computations can grow to non-trivial size and complexity. The host application is in control of how much sophistication is available to users.</p>

<h2 id="requirements">Requirements</h2>

<p>Tweakflow runs on the JVM. Java 8 or later is required.</p>

<h2 id="design-principles">Design principles</h2>

<p>The following sections outline fundamental principles which inform the design of tweakflow.</p>

<h3 id="everything-is-a-value">Everything is a value</h3>

<p>All data and functions in tweakflow are immutable values. You can always create, inspect, compare and pass them around without worrying about object identity or unexpected modifications. There is no way a value in tweakflow can change.</p>

<p>Tweakflow uses <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structures</a> for its collections. It comes with a set of functions in the standard library to make compuations with immutable values easy.</p>

<h3 id="reproducible-calculations">Reproducible calculations</h3>

<p>All functions in tweakflow are pure. The practical consequence is that user-expressions do not maintain state, and cannot trigger any side-effects. All effectful operations like file I/O are performed by the host application. The results of such operations can be passed to user expressions as values, but user expressions cannot introduce any side-effects to the application themselves.</p>

<p>The above paradigm is familiar from spreadsheet applications. Spreadsheets allow users to work with data using formula expressions, but the formulas themselves are deterministic. The outcome of a spreadsheet calculation does not depend on when the spreadsheet was opened and by whom. Similarly, the outcome of tweakflow expressions is guaranteed to be reproducible and side-effect free.</p>

<h3 id="the-host-application-is-in-control">The host application is in control</h3>

<p>Allowing users to perform computations in an application has implications, especially when users can access application internals. Many general-purpose languages on the JVM, like JRuby, Closure, Scala, or various implementations of Javascript have excellent Java interop capabilities. This is great for trusted code and admin-level features, but it comes at the cost of potential security problems when exposed to a broad audience of users. Java interop in a scripting language makes it realtively easy to call into application internals not intended to be accessed by user scripts, or to access application data that should not be exposed to the user.</p>

<p>Tweakflow functions can be written in Java, but they must implement an interface. Calling arbitrary Java code is not possible. When embedding tweakflow, the host application can also set up a load path that controls which tweakflow code can contain functions implemented in Java. In addition, the host application can remove or replace the default standard library that comes with tweakflow. As a result applications control precisely what the user expressions can call or have access to.</p>

<h2 id="lexical-structure">Lexical structure</h2>

<h3 id="keywords">Keywords</h3>

<p>Tweakflow recognizes the following keywords during lexical analysis. These tokens carry meaning as syntactic or semantic elements and cannot be used as identifiers unless noted otherwise in the identifiers section.</p>

<p><code>alias</code>, <code>and</code>, <code>any</code>, <code>as</code>, <code>boolean</code>, <code>catch</code>, <code>datetime</code>, <code>debug</code>, <code>default</code>, <code>dict</code>, <code>doc</code>, <code>double</code>, <code>else</code>, <code>export</code>, <code>false</code>, <code>for</code>, <code>from</code>, <code>function</code>, <code>global</code>, <code>global::</code>, <code>if</code>, <code>import</code>, <code>in_scope</code>, <code>interactive</code>, <code>is</code>, <code>let</code>, <code>library</code>, <code>library::</code>, <code>list</code>, <code>local::</code>, <code>long</code>, <code>match</code>, <code>meta</code>, <code>module</code>, <code>module::</code>, <code>nil</code>, <code>not</code>, <code>or</code>, <code>provided</code>, <code>string</code>, <code>then</code>, <code>throw</code>, <code>true</code>, <code>try</code>, <code>typeof</code>, <code>via</code>, <code>void</code></p>

<p>The following tokens are recognized as operators, and cannot be used in identifiers.</p>

<p><code>(</code>, <code>)</code>, <code>{</code>, <code>}</code>, <code>[</code>, <code>]</code>, <code>&lt;-</code>, <code>-&gt;&gt;</code>, <code>&gt;&gt;&gt;</code>, <code>&gt;&gt;</code>, <code>&lt;&lt;</code>, <code>,</code>, <code>===</code>, <code>==</code>, <code>=</code>, <code>:</code>, <code>!</code>, <code>+</code>, <code>-</code>, <code>&lt;=</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&gt;</code>, <code>//</code>, <code>/</code>, <code>%</code>, <code>!==</code>, <code>!=</code>, <code>**</code>, <code>*</code>, <code>&amp;&amp;</code>, <code>&amp;</code>, <code>||</code>, <code>|</code>, <code>^</code>, <code>-&gt;</code>, <code>...</code>, <code>..</code>, <code>.</code>, <code>'</code>, <code>\\</code>, <code>~</code>, <code>$</code>, <code>::</code>, <code>@</code></p>

<h3 id="boolean-literals">Boolean literals</h3>

<p>The tokens <code>true</code> and <code>false</code> are interpreted as boolean literals.</p>

<h3 id="the-nil-literal">The nil literal</h3>

<p>The <code>nil</code> literal represents the singleton <a href="#nil">nil value</a>.</p>

<h3 id="long-literals">Long literals</h3>

<p>Decimal digits are read as 64-bit signed integers of type <code>long</code>. A prefix of <code>-</code> indicates a negative value.</p>

<pre><code class="language-javascript">42
-2
</code></pre>

<p>Long literals can also be written in hexadecimal form. They are notated as <code>0x</code> followed by up to  8 bytes. Each byte consists of two hexadecimal digits from <code>[0-9a-fA-F]</code>. The bytes are given in  big-endian order, meaning that the most significant byte is written first. If less than 8 bytes are provided, missing leading bytes are filled up with zeros. The resulting bit pattern is interpreted as a <a href="https://en.wikipedia.org/wiki/Two%27s_complement">two&rsquo;s complement</a> signed 64-bit integer, exactly like a Java long value.</p>

<pre><code class="language-ruby">&gt; 0x00
0

&gt; 0xFF
255

&gt; 0xE5E7
58855

&gt; 0xFFFFFFFFFFFFFFFF
-1

&gt; 0x7FFFFFFFFFFFFFFF
9223372036854775807

&gt; 0x8000000000000000
-9223372036854775808
</code></pre>

<h3 id="double-literals">Double literals</h3>

<p>Floating point numbers are read as 64 bit double precision literals of type <code>double</code> based on the IEEE 754 specification, exactly like double values in Java.</p>

<p>There are several ways to notate a double literal:</p>

<ul>
<li>As integer followed by decimal dot, followed by fraction digits and optional exponent notation</li>
<li>As decimal dot, followed by fraction digits and optional exponent notation</li>
<li>As integer followed by exponent notation</li>
</ul>

<p>Exponent notation is given by an <code>e</code> or <code>E</code> character and followed by the powers of ten to multiply with.</p>

<pre><code class="language-ruby"># various ways to write the decimal number 3.1315

&gt; 3.1315
3.1315

&gt; 0.31315e1
3.1315

&gt; .31315E1
3.1315

&gt; 31315e-4
3.1315
</code></pre>

<p>Tweakflow does not support hexadecimal notation for doubles.</p>

<p>In addition to regular numbers <code>NaN</code> (Not a Number) and <code>Infinity</code> literals can be used.</p>

<pre><code class="language-ruby">&gt; Infinity
Infinity

&gt; -Infinity
-Infinity

&gt; Infinity - Infinity
NaN

&gt; Infinity * 2.0
Infinity

&gt; NaN + 1
NaN

&gt; typeof Infinity
&quot;double&quot;

&gt; typeof NaN
&quot;double&quot;
</code></pre>

<h3 id="string-literals">String literals</h3>

<p>Strings can occur in many places of an expression or program, playing different semantic roles. Stings appear as keys in dictionaries, as computation values, or as documentation strings, for example. Tweakflow offers several ways to write a literal string. The notations are interchangeable. Each of the notations is valid at any place a string is valid.</p>

<h4 id="single-quoted-strings">Single-quoted strings</h4>

<p>A single quoted string begins and ends with a single quote character <code>'</code>. Line breaks, tabs, and other special characters are allowed, and included in the string verbatim. If a single-quote character is to be included in the string, it must be escaped with another single-quote. Aside from that, a single-quoted string does not expand any escape sequences.</p>

<pre><code class="language-ruby">&gt; 'hello world'
&quot;hello world&quot;

&gt; 'a single quote: '''
&quot;a single quote: '&quot;

&gt; 'Joe''s Bar'
&quot;Joe's Bar&quot;

&gt; \e
'Line 1
Line 2
Line 3'
\e
&quot;Line 1
Line 2
Line 3&quot;
</code></pre>

<h4 id="double-quoted-strings">Double-quoted strings</h4>

<p>A double-quoted string begins and ends with a double quote character <code>&quot;</code>. Line breaks, tabs, and other special characters are allowed, and included in the string verbatim. The following escape sequences are expanded:</p>

<table>
<thead>
<tr>
<th>Escape sequence</th>
<th>Expands to</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>\\</code></td>
<td><code>\</code> backslash</td>
</tr>

<tr>
<td><code>\&quot;</code></td>
<td><code>&quot;</code> double quote</td>
</tr>

<tr>
<td><code>\t</code></td>
<td><code>⇥</code> tab character</td>
</tr>

<tr>
<td><code>\#</code></td>
<td><code>#</code> hash character</td>
</tr>

<tr>
<td><code>\n</code></td>
<td><code>⏎</code> newline character</td>
</tr>

<tr>
<td><code>\r</code></td>
<td><code>⏎</code> carriage return character</td>
</tr>

<tr>
<td><code>\u[byte]{2}</code></td>
<td>unicode character from the <a href="https://en.wikipedia.org/wiki/Plane_(Unicode)#Basic_Multilingual_Plane">basic multilingual plane</a> given by the two-byte address</td>
</tr>

<tr>
<td><code>\U[byte]{4}</code></td>
<td>any unicode character given by the full four-byte address</td>
</tr>

<tr>
<td><code>#{reference}</code></td>
<td>value given by the reference when cast to string</td>
</tr>
</tbody>
</table>

<p>To prevent expansion of escape sequences beginning with a backslash, escape the backslash, so it is interpreted literally. To prevent expansion of a variable reference, escape the hash character that opens the sequence, so it is interpreted literally.</p>

<pre><code class="language-ruby">&gt; &quot;hello world&quot;
&quot;hello world&quot;

&gt; &quot;hello\nworld&quot;
&quot;hello
world&quot;

&gt; &quot;hello\\nworld&quot;
&quot;hello\\nworld&quot;

&gt; &quot;A \u2287 B&quot;
&quot;A ⊇ B&quot;

&gt; &quot;I like \U0001d11e&quot;
&quot;I like 𝄞&quot;

&gt; name: &quot;Joe&quot;
&quot;Joe&quot;
&gt; &quot;#{name}'s Bar&quot;
&quot;Joe's Bar&quot;
</code></pre>

<h4 id="here-document-strings">Here document strings</h4>

<p>The <a href="https://en.wikipedia.org/wiki/Here_document">here document</a> string notation starts with <code>~~~\r?\n</code> and ends with <code>\r?\n~~~</code>. All characters inbetween are preserved as a literal string that does not expand any escape sequences.</p>

<pre><code>​~~~
[literal string]
​~~~
</code></pre>

<p>This style of string is useful when the role of a string is to represent a seperate document. It is typically used for documentation or embedded documents.</p>

<pre><code class="language-ruby">&gt; \e
​~~~
Hello World
​~~~
\e
&quot;Hello World&quot;

&gt; \e
​~~~
&lt;Contact&gt;  
  &lt;Name&gt;John Doe&lt;/Name&gt;  
  &lt;Title&gt;CEO&lt;/Title&gt;  
  &lt;Phone&gt;  
    &lt;Number&gt;555-8401&lt;/Number&gt;  
    &lt;Type&gt;Voice&lt;/Type&gt;  
  &lt;/Phone&gt;  
&lt;/Contact&gt;
​~~~
\e
&quot;&lt;Contact&gt;  
&lt;Name&gt;John Doe&lt;/Name&gt;  
  &lt;Title&gt;CEO&lt;/Title&gt;  
  &lt;Phone&gt;  
    &lt;Number&gt;555-8401&lt;/Number&gt;  
    &lt;Type&gt;Voice&lt;/Type&gt;  
  &lt;/Phone&gt;  
&lt;/Contact&gt;&quot;
</code></pre>

<h4 id="symbol-strings">Symbol strings</h4>

<p>Tweakflow allows symbol notation for strings. It can be useful to distinguish strings used as keys in dicts or as enumeration items from data strings. Symbol strings follow identifier notation rules, but are prepended with a <code>:</code>. Their name is their value.</p>

<p>A symbol string is written as:</p>

<pre><code class="language-text">:[a-zA-Z_][a-zA-Z_0-9?]*
</code></pre>

<p>The escaped form with backticks allows an unconstrained set of characters, with the exception of the backtick itself:</p>

<pre><code class="language-text">:`.+?`
</code></pre>

<p>Symbol strings are regular strings. They are merely a notational convenience to distinguish data strings from strings used as keys. Therefore symbol notation is allowed in all places a string is accepted.</p>

<pre><code class="language-ruby">&gt; :foo
&quot;foo&quot;

&gt; :`Hello World`
&quot;Hello World&quot;

&gt; nums: {:one 1, :two 2, :three 3}
{
  :one 1,
  :two 2,
  :three 3
}
&gt; nums[:one]
1
&gt; nums[&quot;two&quot;]
2

&gt; :Hello .. :` ` .. :World
&quot;Hello World&quot;
</code></pre>

<h3 id="datetime-literals">Datetime literals</h3>

<p>Datetime literals can be specified at various levels of granularity. Starting at the level of days, the datetime literals take the form <code>[year]-[month]-[day]T</code>  with year given as four digits, month and day give as two digits each.</p>

<pre><code class="language-ruby">&gt; 2017-04-30T
2017-04-30T00:00:00Z@UTC
</code></pre>

<p>The basic form is extended to specify the local time in 24 hour format as <code>[hours]:[minutes]:[seconds](.[fraction_of_seconds])?</code> with two digits for hours, minutes, and seconds, and up to nine digits for the optional fraction of seconds.</p>

<pre><code class="language-ruby">&gt; 2017-04-30T21:32:11
2017-04-30T21:32:11Z@UTC

&gt; 2017-04-30T21:32:11.123456789
2017-04-30T21:32:11.123456789Z@UTC
</code></pre>

<p>The local time form is extended to specify an offset from UTC of the form <code>((+|-)[offset_hours]:[offset_minutes])|Z</code>  where offset hours and offset minutes is specified with 2 digits each. The shorthand Z means UTC time, no offset.</p>

<pre><code class="language-ruby">&gt; 2017-04-30T21:32:11+02:00
2017-04-30T21:32:11+02:00@`UTC+02:00`

&gt; 2017-04-30T21:32:11Z
2017-04-30T21:32:11Z@UTC
</code></pre>

<p>The UTC offset form can be further refined to include the regional time zone, ensuring consistency of local time calculations while observing daylight saving time. The regional time zone form appends an <code>@</code> sign, followed by the id of the desired time zone. The time zone id follows the same escaping rules as <a href="#identifiers">identifiers</a>, and will often have to be escaped by backticks.</p>

<p>Time zones are valid if recognized by Java&rsquo;s <a href="https://docs.oracle.com/javase/8/docs/api/java/time/ZoneId.html#of-java.lang.String-">ZoneId.of</a>. A list of known regional zone ids can be obtained by calling <a href="/tweakflow/modules/std.html#zones">time.zones</a> of the tweakflow standard module. In addition, time zones giving a constant offset from UTC or GMT are accepted, as per the documentation of <a href="https://docs.oracle.com/javase/8/docs/api/java/time/ZoneId.html#of-java.lang.String-">ZoneId.of</a>.</p>

<pre><code class="language-ruby">&gt; 2017-04-30T21:32:11+02:00@`Europe/Berlin`
2017-04-30T21:32:11+02:00@`Europe/Berlin`

&gt; 2017-04-30T21:32:11+02:00@`UTC+02:00`
2017-04-30T21:32:11+02:00@`UTC+02:00`
</code></pre>

<h3 id="identifiers">Identifiers</h3>

<p>Tweakflow identifiers take one of the following forms.</p>

<p>The first form consists of an alphabetic or underscore character, followed by zero or more alphanumeric, underscore or question mark characters:</p>

<pre><code class="language-text">[a-zA-Z_][a-zA-Z_0-9?]*
</code></pre>

<p>The escaped form with backticks allows an unconstrained set of characters, with the exception of the backtick itself:</p>

<pre><code class="language-text">`.+?`
</code></pre>

<p>The following example uses both variants of the syntax. The variable <code>%name%</code> has characters that are not permitted in an identifier, and is therefore escaped:</p>

<pre><code class="language-ruby">&gt; \e
let {
  greeting: &quot;Hello&quot;
  `%name%`: &quot;Joe&quot;
}
greeting .. &quot; &quot; .. `%name%`
\e
&quot;Hello Joe&quot;
</code></pre>

<h3 id="end-of-statement-markers">End-of-statement markers</h3>

<p>Tweakflow allows to explicitly mark the end of a statement with a semicolon or newline. Any definition statements  for modules, libraries, imports, aliases, exports, and variables can be separated by any number of newlines or semicolons.</p>

<p>Tweakflow is structured to not be ambiguous in the absence of end-of-statement markers, and as such any end-of-statement markers are entirely optional. The markers are useful to improve readability. They are parsed as whitespace and discarded. Consecutive end-of-statement markers are read as one.</p>

<p>Below example has variable definitions separated by end-of-statement markers. Both semicolon and newline are used to clearly separate the variable definitions:</p>

<pre><code class="language-ruby">&gt; \e
let {
  a: 1;
  b: 2;
} a+b
\e
3
</code></pre>

<p>Equivalent, but arguably less readable notation with variable definitions lacking end-of-statement separation:</p>

<pre><code class="language-ruby">&gt; let { a: 1 b: 2 } a+b
3
</code></pre>

<h3 id="comments">Comments</h3>

<p>Tweakflow supports line comments and span comments. Each form catering to different uses of comments in code.</p>

<h4 id="line-comments">Line comments</h4>

<p>The <code>#</code> token signifies a line comment. The <code>#</code> character and all subsequent characters to the next newline are ignored.</p>

<pre><code class="language-ruby">&gt; 3 # This is a comment
3
</code></pre>

<h4 id="span-comments">Span comments</h4>

<p>The comment markers <code>/*</code> and <code>*/</code> enclose a comment that can span multiple lines. Span comments can be nested.</p>

<pre><code class="language-text">&gt; 3 /* This is a comment */
3

&gt; /* this is a /* nested */ comment */ 3
3

&gt; \e
/*
this comment
spans multiple lines
*/
&quot;hello&quot;
\e
&quot;hello&quot;
</code></pre>

<h2 id="semantic-structure">Semantic structure</h2>

<h3 id="data-types">Data types</h3>

<p>Tweakflow supports a fixed set of data types. Each data type has literal notation, and a set of supported cast targets to other types. The following sections highlight all available types and their characteristics.</p>

<h4 id="boolean">Boolean</h4>

<p>The <code>boolean</code> type holds the values <code>true</code> and <code>false</code>. Booleans are notated using <a href="#boolean-literals">boolean literals</a>. The following type casts are supported:</p>

<h5 id="boolean-as-long">Boolean as long</h5>

<p>Boolean <code>true</code> is cast to <code>1</code> and boolean <code>false</code> is cast to <code>0</code>.</p>

<h5 id="boolean-as-double">Boolean as double</h5>

<p>Boolean <code>true</code> is cast to <code>1.0</code> and boolean <code>false</code> is cast to <code>0.0</code>.</p>

<h5 id="boolean-as-string">Boolean as string</h5>

<p>Boolean <code>true</code> is cast to <code>&quot;true&quot;</code> and boolean <code>false</code> is cast to <code>&quot;false&quot;</code>.</p>

<h4 id="long">Long</h4>

<p>The <code>long</code> type holds 64-bit signed integers. Integers are notated using <a href="#long-literals">long literals</a>. The following type casts are supported:</p>

<h5 id="long-as-boolean">Long as boolean</h5>

<p>The long <code>0</code> is converted to <code>false</code>. Any other long value is converted to <code>true</code>.</p>

<h5 id="long-as-double">Long as double</h5>

<p>The long number is converted to to closest double value possible.</p>

<h5 id="long-as-string">Long as string</h5>

<p>The long is converted to a decimal number with a potential leading minus sign.</p>

<h5 id="long-as-datetime">Long as datetime</h5>

<p>The long is interpreted as the number of milliseconds passed since <code>time.epoch</code> in UTC.</p>

<pre><code class="language-ruby">&gt; 0 as datetime
1970-01-01T00:00:00Z@UTC

&gt; 1501757830000 as datetime
2017-08-03T10:57:10Z@UTC

&gt; -1501757830000 as datetime
1922-05-31T13:02:50Z@UTC
</code></pre>

<h4 id="double">Double</h4>

<p>The <code>double</code> type holds 64-bit double-precision IEEE 754 floating point numbers. Literal floating point numbers are notated using <a href="#double-literals">double literals</a>. The following type casts are supported:</p>

<h5 id="double-as-boolean">Double as boolean</h5>

<p>The double values <code>0.0</code>,  <code>-0.0</code>, and <code>NaN</code> are converted to <code>false</code>. Any other values are converted to <code>true</code>.</p>

<h5 id="double-as-long">Double as long</h5>

<p>The double value is truncated at the decimal point and converted to the closest long value.</p>

<h5 id="double-as-string">Double as string</h5>

<ul>
<li>If the double value is <code>NaN</code>, the string is <code>&quot;NaN&quot;</code>.</li>
<li>If the double value is positive infinity, the string is <code>&quot;Infinity&quot;</code>.</li>
<li>if the double value is negative infinity, the string is <code>&quot;-Infinity&quot;</code>.</li>
<li>if the double value is 0.0, the string is <code>&quot;0.0&quot;</code></li>
<li>if the double value is -0.0, the string is <code>&quot;-0.0&quot;</code></li>
</ul>

<p>For any other double value, the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Double.html#toString-double-">conventions the Java language</a> are used.</p>

<p>Casting doubles to string should only be done for non-functional purposes like data-inspection, debugging or logging. The standard library offers <a href="/tweakflow/modules/std.html#formatter-1">formatters</a> to to convert double values to strings in a controlled output format.</p>

<h4 id="string">String</h4>

<p>The <code>string</code> type holds text information. Strings are notated using <a href="#string-literals">string literals</a>. The following type casts are supported:</p>

<h5 id="string-as-boolean">String as boolean</h5>

<p>The empty string <code>&quot;&quot;</code> is cast to <code>false</code>. Any other string value is cast to <code>true</code>.</p>

<h5 id="string-as-long">String as long</h5>

<p>The string is first trimmed of whitespace on both sides. It is then interpreted as a decimal number with an optional leading <code>+</code> or <code>-</code> sign, any leading zeros, and digits <code>0-9</code>. The trimmed string must conform to the regular expression:</p>

<pre><code class="language-text">[+-]?[0-9]+
</code></pre>

<p>If the resulting number does not fit in a 64-bit signed integer, an error is thrown.</p>

<h5 id="string-as-double">String as double</h5>

<p>Strings cast to doubles successfully if they pass the following regular expression:</p>

<pre><code class="language-text">[\x00-\x20]*                                 # optional leading whitespace
[+-]?                                        # optional sign
(NaN)|                                       # Not a Number
(Infinity)|                                  # Infinity
([0-9]+(\.[0-9]+)?([eE][+-]?[0-9]+)?)|       # Digits optionally followed by decimal dot
                                             # fractional digits, and exponent                                              
\.[0-9]+([eE][+-]?[0-9]+)?)                  # decimal dot followed by fractional digits
                                             # and exponent
[\x00-\x20]*                                 # optional trailing whitespace
</code></pre>

<p>Examples for casts from string to double:</p>

<pre><code class="language-ruby">&gt; &quot;1.0&quot; as double
1.0

&gt; &quot;2e3&quot; as double
2000.0

&gt; &quot;2230.3e-1&quot; as double
223.03

&gt; &quot;.98e2&quot; as double
98.0

&gt; &quot;200.0kg&quot; as double
ERROR: {
  :message &quot;Cannot cast 200.0kg to double&quot;,
  ...
}
</code></pre>

<h5 id="string-as-list">String as list</h5>

<p>A string is converted to a list of individual character strings. More precisely, it is converted to a list of its unicode codepoints.</p>

<pre><code class="language-ruby">&gt; &quot;&quot; as list
[]

&gt; &quot;hello&quot; as list
[&quot;h&quot;, &quot;e&quot;, &quot;l&quot;, &quot;l&quot;, &quot;o&quot;]

&gt; &quot;I love 𝄞&quot; as list
[&quot;I&quot;, &quot; &quot;, &quot;l&quot;, &quot;o&quot;, &quot;v&quot;, &quot;e&quot;, &quot; &quot;, &quot;𝄞&quot;]
</code></pre>

<h4 id="datetime">Datetime</h4>

<p>The <code>datetime</code> type represents points in time while also carrying regional time zone information. Datetimes are notated using <a href="#datetime-literals">datetime literals</a>.</p>

<p>The following type casts are supported:</p>

<h5 id="datetime-as-boolean">Datetime as boolean</h5>

<p>All datetime values cast to boolean <code>true</code>.</p>

<h5 id="datetime-as-string">Datetime as string</h5>

<p>A datetime value casts to a string compatible with <a href="#datetime-literals">datetime literal</a> notation.</p>

<pre><code class="language-ruby">&gt; time.epoch as string
&quot;1970-01-01T00:00:00Z@UTC&quot;
</code></pre>

<p>Casting datetimes to string should only be done for non-functional purposes like data-inspection, debugging or logging. The standard library offers <a href="/tweakflow/modules/std.html#formatter">formatters</a> to to convert datetime values to strings in a controlled output format.</p>

<h5 id="datetime-as-dict">Datetime as dict</h5>

<p>A datetime value casts to a dict that contains all of its fields together with day of week, day of year, and week of year information. Supposing <code>x</code> is the datetime to cast, and <code>time</code> is the library from the standard module, the dict is equivalent to the following definition:</p>

<pre><code class="language-ruby">{
  :year              time.year(x),
  :month             time.month(x),
  :day_of_month      time.day_of_month(x),
  :hour              time.hour(x),
  :minute            time.minute(x),
  :second            time.second(x),
  :nano_of_second    time.nano_of_second(x),
  :day_of_year       time.day_of_year(x),
  :day_of_week       time.day_of_week(x)
  :week_of_year      time.week_of_year(x),
  :offset_seconds    time.offset_seconds(x),
  :zone              time.zone(x)
}
</code></pre>

<p>For example:</p>

<pre><code class="language-ruby">&gt; time.epoch as dict
{
  :month 1,
  :day_of_year 1,
  :hour 0,
  :zone &quot;UTC&quot;,
  :nano_of_second 0,
  :offset_seconds 0,
  :second 0,
  :minute 0,
  :day_of_week 4,
  :week_of_year 1,
  :day_of_month 1,
  :year 1970
}

&gt; 2017-07-23T23:12:32.298+02:00@`Europe/Berlin` as dict
{
  :month 7,
  :day_of_year 204,
  :hour 23,
  :zone &quot;Europe/Berlin&quot;,
  :nano_of_second 298000000,
  :offset_seconds 7200,
  :second 32,
  :minute 12,
  :day_of_week 7,
  :week_of_year 29,
  :day_of_month 23,
  :year 2017
}
</code></pre>

<h4 id="list">List</h4>

<p>The <code>list</code> type holds a finite sequence of values in a defined order. It is equivalent to array types in other languages. They are indexed by long values, starting at index 0. Lists are internally indexed by integers and have a capacity limit of 2^31 = 2.147.483.648 elements.</p>

<p>Lists are notated as a sequence of values inside square brackets. Commas separating entries are optional. The empty list is written as <code>[]</code>.</p>

<p>A splat expression can be used to concatenate lists inline.</p>

<p>The formal syntax of a list literal is as follows:</p>

<pre><code class="language-text">listLiteral
   : '[' ((expression|splat) ','? )*  ']'
   ;

splat
  : '...' expression
  ;  
</code></pre>

<p>A few example lists:</p>

<pre><code class="language-ruby">&gt; [1, 2, 3] # a basic list
[1, 2, 3]

&gt; [1 2 3] # commas are optional
[1, 2, 3]

&gt; [] # empty list
[]

&gt; [[1, 2], [3, 4]] # lists can be nested
[[1, 2], [3, 4]]

&gt; [{:id 1, :name &quot;Johne Doe&quot;}, {:id 2, :name &quot;Jane Doe&quot;}] # lists nest with dicts
[{
  :name &quot;Johne Doe&quot;,
  :id 1
}, {
  :name &quot;Jane Doe&quot;,
  :id 2
}]
</code></pre>

<p>It is worth noting that <a href="#container-access">container access</a> has precedence over sequencing items in a list literal, which can lead to unexpected results when nesting list literals. You can disambiguate by placing explicit commas to sequence list items.</p>

<pre><code class="language-ruby">&gt; [[&quot;a&quot;, &quot;b&quot;] [0]]   # container access x[0] has precedence over list literal sequence
[&quot;a&quot;]

&gt; [[&quot;a&quot;, &quot;b&quot;], [0]]  # ambiguity resolved
[[&quot;a&quot;, &quot;b&quot;], [0]]
</code></pre>

<p>When a splat expression is encountered, it is evaluated, cast to list and concatenated with any previous list items. A few examples of splats:</p>

<pre><code class="language-ruby">&gt; [1, 2, ...[3, 4, 5]]
[1, 2, 3, 4, 5]

&gt; [1, 2, ...{:key &quot;value&quot;}, 3] # the splat dict is cast to a list before concat
[1, 2, &quot;key&quot;, &quot;value&quot;, 3]
 
&gt; prepend: (x, list xs) -&gt; list [x, ...xs]
function
&gt; prepend(&quot;a&quot;, [&quot;b&quot;, &quot;c&quot;])
[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]

&gt; append: (list xs, x) -&gt; list [...xs, x]
function
&gt; append([&quot;x&quot;, &quot;y&quot;], &quot;z&quot;)
[&quot;x&quot;, &quot;y&quot;, &quot;z&quot;]
</code></pre>

<p>The following type casts are supported:</p>

<h5 id="list-as-boolean">List as boolean</h5>

<p>An empty list <code>[]</code> converts to <code>false</code>. Any other list value converts to <code>true</code>.</p>

<h5 id="list-as-dict">List as dict</h5>

<p>Lists are converted as sequences of key-value pairs. <code>[&quot;a&quot; 1 &quot;b&quot; 2]</code> is converted to <code>{:a 1 :b 2}</code>. Items in key position are cast to strings. The conversion proceeds left to right, with any duplicate keys being replaced with the rightmost occurrence. If the list has an odd number of items, an error is thrown. If any of the keys is <code>nil</code> or cannot be cast to string, an error is thrown.</p>

<pre><code class="language-ruby">&gt; [&quot;a&quot; 1 &quot;b&quot; 2 &quot;c&quot; 3] as dict
{
  :a 1,
  :b 2,
  :c 3
}

&gt; [1 2 3 4] as dict
{
  :`1` 2,
  :`3` 4
}

&gt; [] as dict
{}

&gt; [&quot;a&quot; &quot;b&quot; &quot;a&quot; &quot;d&quot;] as dict # rightmost key &quot;a&quot; takes precedence
{
  :a &quot;d&quot;
}

&gt; [&quot;a&quot; nil &quot;b&quot; 1] as dict # nil values are allowed
{
  :a nil,
  :b 1
}

&gt; [&quot;a&quot; &quot;b&quot; nil &quot;d&quot;] as dict # nil keys are not allowed
ERROR: {
  :message &quot;Cannot cast list to dict with nil key at index: 2&quot;,
  ...
}

&gt; [1 2 3] as dict
ERROR: {
  :message &quot;Cannot cast list with odd number of items to dict&quot;,
  ...
}
</code></pre>

<h4 id="dict">Dict</h4>

<p>The <code>dict</code> type is an associative structure that maps string keys are to arbitrary values. Dicts do not support <code>nil</code> keys, but <code>nil</code> values are permitted. The order of keys in a dict is undefined.</p>

<p>Dicts are notated as a sequence of key and value pairs inside curly brackets. Keys are implicitly cast to strings. Commas separating entries are optional. The empty dict is written as <code>{}</code>.</p>

<p>A splat expression can be used to merge dicts inline.</p>

<p>The formal syntax of a dict literal is as follows:</p>

<pre><code>dictLiteral
   : '{' ((expression expression)|(splat) ','? )*  '}'
   ;

splat
  : '...' expression
  ;
</code></pre>

<p>A few example dicts:</p>

<pre><code class="language-ruby">&gt; {:code 200, :status &quot;found&quot;, :size 1232}
{
  :size 1232,
  :code 200,
  :status &quot;found&quot;
}

&gt; {&quot;one&quot; 1, &quot;two&quot; 2}
{
  :one 1,
  :two 2
}

&gt; {:result &quot;ok&quot;, :content_types [&quot;xml&quot;, &quot;json&quot;]} # dicts nest with lists
{
  :content_types [&quot;xml&quot;, &quot;json&quot;],
  :result &quot;ok&quot;
}

# dicts nest with other dicts
&gt; {:people {&quot;1&quot; {:id 1, :name &quot;John Doe&quot;}, &quot;2&quot; {:id 2, :name &quot;Jane Doe&quot;}}}
{
  :people {
    :`1` {
      :name &quot;John Doe&quot;,
      :id 1
    },
    :`2` {
      :name &quot;Jane Doe&quot;,
      :id 2
    }
  }
}
</code></pre>

<p>When a splat expression is encountered, the splat value is cast to dict and merged with the existing dict. The rightmost merged dict values take precedence in case splats contain keys that are already present.</p>

<pre><code class="language-ruby">&gt; {:code 200, ...{:status &quot;found&quot;, :size 1232}}
{
  :size 1232,
  :code 200,
  :status &quot;found&quot;
}
 
# rightmost value for key :status is preserved
&gt; {:request_id 8273, :status &quot;ok&quot;, ...{:code 403, :status &quot;forbidden&quot;}}
{
  :request_id 8273,
  :code 403,
  :status &quot;forbidden&quot;
}
</code></pre>

<p>The following type casts are supported:</p>

<h5 id="dict-as-boolean">Dict as boolean</h5>

<p>The empty dict <code>{}</code> converts to <code>false</code>. Any other dict value converts to <code>true</code>.</p>

<h5 id="dict-as-list">Dict as list</h5>

<p>Dicts are converted to lists as a sequence of key-value pairs. An empty dict gives an empty list. Keys and values appear in pairs, but the order of the pairs is not defined.</p>

<pre><code class="language-ruby">&gt; {} as list
[]

&gt; {:a &quot;foo&quot; :b &quot;bar&quot;} as list
[&quot;a&quot;, &quot;foo&quot;, &quot;b&quot;, &quot;bar&quot;]

&gt; {:a 1 :b 2}  as list
[&quot;a&quot;, 1, &quot;b&quot;, 2]

&gt; {:b 1 :a 2}  as list
[&quot;a&quot;, 2, &quot;b&quot;, 1]
</code></pre>

<h4 id="function">Function</h4>

<p>The <code>function</code> type holds callable functions. There is only one data type for functions. It encompasses functions of all signatures.</p>

<p>Function notation has two parts: function head, and body. The head holds the function signature: paramter list and return type. The body is either an expression that evaluates to the function&rsquo;s return value, or a structure specifying the Java class that is implementing the function.</p>

<p>Formally function syntax is as follows:</p>

<pre><code class="language-text">functionLiteral
  : functionHead (expression|viaDec)
  ;

functionHead
  : '(' paramsList ')' '-&gt;' dataType?
  ;

paramsList
  : (paramDef ','?) *
  ;

paramDef
  : dataType? identifier ('=' expression)?
  ;

viaDec
  : 'via' literal
  ;
</code></pre>

<p>A function head specifies a parameter list, and an optional return type. If the return type is omitted <code>any</code> is used. Parameter list items can be delimited by a comma, or just whitespace. Each parameter has a name, an optional data type, and an optional default value. If the data type is omitted, <code>any</code> is used, if the default value is omitted <code>nil</code> is used. When a function is invoked, all arguments are implicitly cast to the declared parameter types.</p>

<p>If a function body is an expression, it is evaluated to the return value when the function is called. The return value is implicitly cast to the declared return value of the function.</p>

<p>The following type casts are supported:</p>

<h5 id="function-as-boolean">Function as boolean</h5>

<p>All function values cast to boolean <code>true</code>.</p>

<p>Some examples:</p>

<pre><code class="language-ruby"># A function with no parameters, returning a constant of any type
&gt; f: () -&gt; 1
function
&gt; f()
1

# A function taking two strings and returning a string
&gt; f: (string x, string y) -&gt; string    x .. y
function
&gt; f(&quot;John&quot;, &quot;Doe&quot;)
&quot;JohnDoe&quot;

# A function taking a list and returning a list
&gt; f: (list xs) -&gt; list    data.map(xs, (_, i) -&gt; xs[data.size(xs)-1-i])
function
&gt; f([1,2,3])
[3, 2, 1]

# A function taking two doubles, each having a default value, returning a double
&gt; f: (double x=1.0, double y=0.0) -&gt; double    x+y
function
&gt; f(3, 4)
7.0
&gt; f()
1.0
&gt; f(0)
0.0
&gt; f(x: 2, y: 3)
5.0
&gt; f(y: 7)
8.0

# reminder: string cast to list gives the characters in a list
&gt; &quot;hello&quot; as list
[&quot;h&quot;, &quot;e&quot;, &quot;l&quot;, &quot;l&quot;, &quot;o&quot;]

# the returned value, a string, is cast to the declared return type, a list
&gt; f: (string x, string y) -&gt; list  x..y
function
&gt; f(&quot;Foo&quot;, &quot;Bar&quot;)
[&quot;F&quot;, &quot;o&quot;, &quot;o&quot;, &quot;B&quot;, &quot;a&quot;, &quot;r&quot;]
</code></pre>

<p>The signature of a function can be inspected calling <a href="/tweakflow/modules/std.html#signature">fun.signature</a> from the standard library.</p>

<pre><code class="language-ruby">&gt; f: (double x=1.0, double y=0.0) -&gt; double    x+y
function
&gt; fun.signature(f)
{
  :return_type &quot;double&quot;,
  :parameters [{
    :name &quot;x&quot;,
    :index 0,
    :default_value 1.0,
    :declared_type &quot;double&quot;
  }, {
    :name &quot;y&quot;,
    :index 1,
    :default_value 0.0,
    :declared_type &quot;double&quot;
  }]
}
</code></pre>

<h5 id="functions-in-java">Functions in Java</h5>

<p>Instead of a body expression, tweakflow functions can specify a Java class that implements the function. The notation is the keyword <code>via</code> followed by a map literal containing the key <code>:class</code> which points to a Java class. The Java class must implement the tag interface <a href="#link-to-user">UserFunction</a>, as well as a exactly one of the following interfaces governing parameter passing.</p>

<table>
<thead>
<tr>
<th>Interface</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><a href="#">Arity0UserFunction</a></td>
<td>Implements zero-parameter functions.</td>
</tr>

<tr>
<td><a href="#">Arity1UserFunction</a></td>
<td>Implements single-parameter functions.</td>
</tr>

<tr>
<td><a href="#">Arity2UserFunction</a></td>
<td>Implements functions with two parameters</td>
</tr>

<tr>
<td><a href="#">Arity3UserFunction</a></td>
<td>Implements functions with three paramters.</td>
</tr>

<tr>
<td><a href="#">Arity4UserFunction</a></td>
<td>Implements functions with four parameters</td>
</tr>

<tr>
<td><a href="#">ArityNUserFunction</a></td>
<td>Implements functions with any number of parameters. Arguments are passed as an array of values.</td>
</tr>
</tbody>
</table>

<p>For example, the inner class <a href="https://github.com/twineworks/tweakflow/blob/releases/0.0.1/src/main/java/com/twineworks/tweakflow/std/Strings.java#L43">com.twineworks.tweakflow.std.Strings$concat</a> implements the <code>strings.concat</code> function of the standard library.</p>

<pre><code class="language-ruby">&gt; f: (list xs) -&gt; string via {:class &quot;com.twineworks.tweakflow.std.Strings$concat&quot;}
function
&gt; f([&quot;Foo&quot;, &quot;Bar&quot;, &quot;Baz&quot;])
&quot;FooBarBaz&quot;
</code></pre>

<p>See the standard library functions in <a href="https://github.com/twineworks/tweakflow/tree/releases/0.0.1/src/main/java/com/twineworks/tweakflow/std">std</a> for examples of functions implemented in Java.</p>

<h4 id="void">Void</h4>

<p>The <code>void</code> type is a type that has <code>nil</code> as its only value. The <code>nil</code> value reports <code>void</code> as its type, even though it is a valid member of any type.</p>

<p>The only <code>void</code> value <code>nil</code> casts successfully to any type, and remains <code>nil</code>.</p>

<h4 id="any">Any</h4>

<p>The <code>any</code> type is a type is not concrete type of its own, but it is used to indicate the possibility of any type being present in the given context. The <code>any</code> type is used as a default in type declarations for variables, parameters and return types.</p>

<h3 id="modules">Modules</h3>

<p>Modules are the top level organizational unit in tweakflow. A module is typically a file, but host applications are free to supply modules as in-memory text as well. There is exactly one module per file.</p>

<p>Module files must be encoded in UTF-8. The default file extension for modules is <code>.tf</code>.</p>

<p>The role of a module is to provide a top level grouping of related functions and values. In this sense modules act like namespaces or packages.</p>

<p>A module usually starts with the <code>module</code> keyword. If there are no <a href="#annotations">annotations</a>, the <code>module</code> keyword becomes optional, and the beginning of the file is treated as the beginning of the module.</p>

<p><a href="#global-modules">Global modules</a> need to announce the fact that they are global, and provide a global identifier to store the module in. A global module starts with the keywords <code>global</code> <code>module</code> followed by an identifier. Any  <a href="#annotations">annotations</a> go before that sequence.</p>

<p>Formally modules have the following syntax:</p>

<pre><code>module
  : moduleHead moduleComponent*
  ;

moduleHead
  : nameDec? (importDef | aliasDef | exportDef) *
  ;
  
nameDec
  : metaDef 'module'
  | metaDef 'global' 'module' identifier
  ;

moduleComponent
  : library
  ;
</code></pre>

<h4 id="global-modules">Global modules</h4>

<p>Modules can declare themselves available under a specific name in <a href="#references">global scope</a>. It is an error to load more than one module claiming the same name.</p>

<p>Global modules are designed to facilitate project-wide configuration and global libraries of which there must be exactly one in scope at all times. Individual modules remain in control of their functional dependencies through imports, but their global dependencies are controlled from the outside. When using tweakflow standalone, a global module would be loaded from the command line. When using tweakflow embedded, typically the host application would be loading global modules.</p>

<p><strong>Example use of global modules for configuration</strong></p>

<p>The following set of files constitute configuration variants, available globally as <code>env</code>.</p>

<pre><code class="language-ruby"># environments/local.tf
global module env

export library conf {
  string data_path: &quot;/home/me/my_project/data/&quot;
}
</code></pre>

<pre><code class="language-ruby"># environments/production.tf
global module env

export library conf {
  string data_path: &quot;/var/incoming/data/&quot;
}
</code></pre>

<p>This file uses the environment configuration throught the global reference <code>$env</code>.</p>

<pre><code class="language-ruby"># main.tf
library my_lib {
  file_path: (string prefix) -&gt; $env.conf.data_path .. prefix .. &quot;_data.csv&quot;
}
</code></pre>

<h4 id="imports">Imports</h4>

<p>Import statements bring names exported from other modules into the current module. The syntax allows importing individual names, or all exported names at once. If imported individually, names may be bound to local names that are different from the names in the source module.</p>

<p>It is an error to import a name that is not explicitly exported.</p>

<p>Imported names are placed in <a href="#references">module scope</a>.</p>

<p>Imports have the following syntax:</p>

<pre><code class="language-text">importDef 
  : 'import' importMember (','? importMember)* 'from' modulePath
  ;

importMember
  : moduleImport
  | componentImport
  ; 

moduleImport
  : '*' 'as' importModuleName
  ;

componentImport
  : exportComponentName ('as' importComponentName)?
  ;

importModuleName
  : IDENTIFIER
  ;

importComponentName
  : IDENTIFIER
  ;

exportComponentName
  : IDENTIFIER
  ;

modulePath
  : stringLiteral
  ;
</code></pre>

<p>The given module path is first appended the default module extension if not present. Then the module path is searched for on the load path. If the module path starts with a dot, tweakflow searches for the file relative to the module doing the import. The resulting path must still be on the load path. If the module path does not start with a dot, tweakflow searches all load path locations in their specified order. The order is typically specified on the command line when using <a href="#language-tools">language tools</a> or by the host application when embedding.</p>

<p><strong>Examples</strong></p>

<p>Module <code>&quot;./util/strings.tf&quot;</code> is imported as a whole below. Any exported name <code>x</code> is available as <code>utils.x</code> locally.</p>

<pre><code class="language-javascript">import * as utils from &quot;./util/strings.tf&quot;
</code></pre>

<p>A specific library <code>conversion_lib</code> is imported from <code>&quot;./util/strings.tf&quot;</code> below. Its local name remains <code>conversion_lib</code>.</p>

<pre><code class="language-javascript">import conversion_lib from &quot;./util/strings.tf&quot;
</code></pre>

<p>Specific entities are imported individually below. The import statement references two exported libraries from module <code>&quot;./util/strings.tf&quot;</code>, making them available under local names <code>str</code> and <code>conv</code>.</p>

<pre><code class="language-javascript">import string_lib as str, conversion_lib as conv from &quot;./util/strings.tf&quot;
</code></pre>

<h4 id="aliases">Aliases</h4>

<p>Tweakflow allows local aliases to shorten or relabel names, making local code independent of name conventions in other modules. Aliases are placed in <a href="#module-scope">module scope</a>.</p>

<p>Aliases have the following syntax:</p>

<pre><code class="language-text">aliasDef
  : 'alias' reference 'as' aliasName
  ;

aliasName
  : IDENTIFIER
  ;
</code></pre>

<p>The following module uses aliases.</p>

<pre><code class="language-ruby"># file: aliases.tf
import * as std from &quot;std&quot;

# s can be used as shortcut to std.strings
alias std.strings as s
# map can be used as shortcut to std.data.map
alias std.data.map as map
# aliases can be aliased again
alias map as m

library my_util {
  # s alias used here
  greeting: s.concat([&quot;Hello&quot;, &quot; &quot;, &quot;World!&quot;]) 	# &quot;Hello World!&quot;
  # m alias used here
  mapped: m([1,2,3], (x) -&gt; x*x) 				# [1, 4, 9]
}
</code></pre>

<h4 id="exports">Exports</h4>

<p>A module defines its public interface using exports. Libraries can be exported inline when defined, or explicitly in an export statement. An export statement refers to a name and makes it available for other modules to import. You can optionally specify an export name, that is only visible to other modules when importing, but not within the exporting module itself. Exporting an imported or aliased name is allowed.</p>

<pre><code class="language-text">exportDef
  : 'export' reference ('as' exportName)?
  ;

exportName
  : IDENTIFIER
  ;
</code></pre>

<p>Below example exports the strings standard library under the name <code>str</code>, and a local library <code>common</code> under the name <code>util</code> .</p>

<pre><code class="language-ruby"># lib.tf
import * as std from &quot;std&quot;

export std.strings as str
export common as util

library common {
  ...
}
</code></pre>

<p>The following file imports both the <code>str</code> and the <code>util</code> export.</p>

<pre><code class="language-ruby"># main.tf
import util, str from &quot;./lib.tf&quot;
</code></pre>

<h3 id="libraries">Libraries</h3>

<p>A  library is a named collection of variables. The variables typically hold functions, but they can hold any data type. Libraries can be marked as exports as part of their definition, in which case they are exported from the enclosing module using their given name.</p>

<p><strong>Syntax</strong></p>

<pre><code class="language-text">library
  : metaDef 'export'? 'library' identifier '{' varDef* '}'
  ;
</code></pre>

<p>Below is an exported library holding some functions.</p>

<pre><code class="language-ruby">export library nums {
  function square: (x) 	-&gt; x**2
  function root: (x) 	-&gt; x**0.5
}
</code></pre>

<h3 id="variables">Variables</h3>

<p>A variable is a named entity that holds a value. Variables are placed in <a href="#libraries">libraries</a>. Variables have a name, a  <a href="#data-types">type</a>, and a value. They can also be annotated by <a href="#annotations">docs and metadata</a>.</p>

<pre><code>varDef
  : metaDef dataType? identifier ':' expression 
  | metaDef 'provided' dataType? identifier
  ;
</code></pre>

<p>The type of variables guarantees that referencing a variable results in a value of the specified type. Variable values are cast implicitly if necessary.</p>

<pre><code class="language-ruby">&gt; boolean bool_var: 1
true

&gt; boolean bool_var: 0
false
</code></pre>

<p>If unspecified, the variable type is <code>any</code>, and no implicit casts take place.</p>

<pre><code class="language-ruby">&gt; some_var: 1
1

&gt; any some_var: 1
1
</code></pre>

<p>Variable values are either given directly as <a href="#expressions">expressions</a>, or the variables are marked as <code>provided</code>. The host application is required to set the values of <code>provided</code> variables through the embedding API. Initially, all provided variables have the value <code>nil</code>.</p>

<p>Tweakflow uses strict evaluation. All variables of a library are guaranteed to evaluate even if they are not referenced by other expressions.</p>

<h3 id="annotations">Annotations</h3>

<p>Modules, libraries, and variables support documentation and metadata annotations. These are just literal values associated with the module, library or variable they annotate. They can be inspected in the REPL. Language processing tools like <a href="#tfdoc">tfdoc</a> can extract them to generate project documentation.</p>

<p>Both doc and meta annotations are optional. They can occur in any order before the definition of a module, library or variable. Doc annotations begin with the keyword <code>doc</code> followed by an expression. Meta annotations begin with the keyworkd <code>meta</code> followed by an expression.</p>

<p>The doc and meta expressions must consist of value literals that evaluate to themselves. They cannot contain any form of computation like  operators or function calls. Function literals are also not permitted.</p>

<p>The following module contains a single library with a single function:</p>

<pre><code class="language-ruby">module

library bar {
  function baz: (x) -&gt; x*x
}
</code></pre>

<p>The same module with a full set of annotations at the module, library, and variable level:</p>

<pre><code class="language-ruby"># module foo.tf
doc
​~~~
This is documentation at the module level.
​~~~
meta {
  :title       &quot;foo&quot;
  :description &quot;Description of the module&quot;
  :version     &quot;4.2&quot;
}
module

# library bar
doc
​~~~
This is documentation for library bar.
​~~~
meta {
  :author &quot;John Doe et al.&quot;
  :since  &quot;2.3&quot;
}

library bar {

# function baz
doc
​~~~
This is documentation for function baz.
​~~~
  meta {
    :author &quot;John Doe&quot;
    :date 2017-03-12T
  }
  function baz: (x) -&gt; x*x
}
</code></pre>

<p>You can inspect the documentation and metadata of modules, libraries and variables at the REPL using the <code>\doc</code> and <code>\meta</code> commands.</p>

<pre><code class="language-text">foo.tf&gt; \doc
This is documentation at the module level.
foo.tf&gt; \meta
{
  :version &quot;4.2&quot;,
  :title &quot;foo&quot;,
  :description &quot;Description of the module&quot;
}

foo.tf&gt; \doc bar
This is documentation for library bar.
foo.tf&gt; \meta bar
{
  :author &quot;John Doe et al.&quot;,
  :since &quot;2.3&quot;
}

foo.tf&gt; \doc bar.baz
This is documentation for function baz.
foo.tf&gt; \meta bar.baz
{
  :author &quot;John Doe&quot;,
  :date 2017-03-12T00:00:00Z@UTC
}
</code></pre>

<h3 id="scope">Scope</h3>

<p>TODO</p>

<p>TODO: You can&rsquo;t replace things in scope, importing, aliasing etc. cannot alter existing impor</p>

<h3 id="expressions">Expressions</h3>

<p>Tweakflow expressions evaluate to values. The most basic of which are literal values. All data types can be written as literals. Tweakflow also has function calls, conditionals, list comprehensions, pattern matching, type casts, and several operators for many common computations.</p>

<h4 id="nil">Nil</h4>

<p>The <code>nil</code> value is written as simply <code>nil</code>. Semantiaclly, a <code>nil</code> value indicates the absence of a value. The <code>nil</code> value is special because it is a valid member of all data types. It casts to any type successfully as <code>nil</code>.</p>

<h4 id="value-literals">Value literals</h4>

<p>All tweakflow data types have a literal notation outlined in their respective section under <a href="#data-types">data types</a>.</p>

<h4 id="type-inspection">Type inspection</h4>

<p>Tweakflow allows checking the type of a value using the <code>is</code> keyword.</p>

<pre><code class="language-text">expression 'is' (boolean|string|long|double|datetime|list|dict|function|void|any)
</code></pre>

<p>The check is a boolean expression and it evaluates to <code>true</code> or <code>false</code> depending on whether the given expression evaluates to a  member of the given data type.</p>

<p>As a special case, the <code>nil</code> value, even though a member of any type, only yields true when checked as being member of the <code>void</code> type. Therefore <code>expression is string</code> implies that expression evaluated to a non-nil string.</p>

<p>As a special case, if <code>any</code> is given as data type, the result is true only if the expression evaluates to a value other than <code>nil</code>,  making the <code>expression is any</code> equivalent to <code>expression != nil</code>.</p>

<pre><code class="language-ruby">&gt; &quot;&quot; is string
true

&gt; nil is string
false

&gt; 42 is string
false

&gt; {} is list
false

&gt; [] is list
true

&gt; {} is dict
true

&gt; [1,2] is dict
false

&gt; nil is void
true

&gt; &quot;foo&quot; is any
true

&gt; nil is any
false
</code></pre>

<h4 id="type-casts">Type casts</h4>

<p>The <code>as</code> keyword allows to explicitly cast a value expression to a given type.</p>

<pre><code class="language-text">expression 'as' dataType
</code></pre>

<p>Type casts may throw errors if the types are incompatible or the specific value is not convertible. In general, type casts only succeed if there is either no information loss, or the amount of information loss is no greater than to be expected from the types involved.</p>

<p>Supported type casts are listed for each type in their respective section of <a href="#data-types">data types</a>. Type casts to <code>any</code> always succeed, and leave the value unchanged. Type casts to <code>void</code> only succeed if the value was <code>nil</code>.</p>

<p>A few examples:</p>

<pre><code class="language-ruby">&gt; &quot;1.4&quot; as double # string to double
1.4

&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;] as dict # list to dict
{
  :a &quot;b&quot;,
  :c &quot;d&quot;
}

&gt; 1234567890123 as datetime # long to datetime
2009-02-13T23:31:30.123Z@UTC

&gt; 2017-07-23T23:12:32.298+02:00@`Europe/Berlin` as dict # datetime as dict
{
  :month 7,
  :day_of_year 204,
  :hour 23,
  :zone &quot;Europe/Berlin&quot;,
  :nano_of_second 298000000,
  :offset_seconds 7200,
  :second 32,
  :minute 12,
  :day_of_week 7,
  :week_of_year 29,
  :day_of_month 23,
  :year 2017
}

&gt; nil as string # nil casts to any type
nil
</code></pre>

<h4 id="container-access">Container access</h4>

<p>List and dict contents are accessed using square brackets. Tweakflow supports traversing through deep structure by giving several keys at a time. Splat keys allow traversing paths given by a list at runtime. The formal structure of container access expressions is as follows:</p>

<pre><code class="language-text">containerAccess
  : expression'['containerAccessKeySequence']'
  ;
	
containerAccessKeySequence
  : ((expression | splat) ','?)+
  ;

splat
  : '...' expression
  ;
</code></pre>

<h5 id="list-access">List access</h5>

<p>Indexes supplied for a list are automatically cast to long values.  If the given index does not exist in the list, the value of the access expression is <code>nil</code>. Accessing a <code>nil</code> list yields <code>nil</code>.</p>

<pre><code class="language-ruby">&gt; items: [&quot;a&quot; &quot;b&quot; &quot;c&quot;]
[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]

&gt; items[0]
&quot;a&quot;

&gt; items[1]
&quot;b&quot;

&gt; items[2]
&quot;c&quot;

&gt; items[&quot;2&quot;] # list access indexes are cast to int
&quot;c&quot;

&gt; items[3]
nil

&gt; items[-1]
nil

&gt; items[nil]
nil

&gt; nil[0] # accessing nil yields nil
nil
</code></pre>

<h5 id="dict-access">Dict access</h5>

<p>Dicts are indexed with strings. Keys are automatically cast to strings. If a given key does not exist, the value of the access expression is <code>nil</code>. Accessing <code>nil</code> yields <code>nil</code>.</p>

<pre><code class="language-ruby">&gt; bag: {:a &quot;alpha&quot;, :b &quot;beta&quot;, &quot;1&quot; &quot;one&quot;, &quot;2&quot; &quot;two&quot;}
{
  :a &quot;alpha&quot;,
  :b &quot;beta&quot;,
  :`1` &quot;one&quot;,
  :`2` &quot;two&quot;
}

&gt; bag[:a]
&quot;alpha&quot;

&gt; bag[:b]
&quot;beta&quot;

&gt; bag[:c]
nil

&gt; bag[1]  # key is cast to string automatically
&quot;one&quot;

&gt; bag[2] # key is cast to string automatically
&quot;two&quot;

&gt; bag[3] # key is cast to string automatically
nil

&gt; bag[nil]
nil

&gt; nil[:key] # accessing a nil dict yields nil
nil
</code></pre>

<h5 id="container-traversal">Container traversal</h5>

<p>Container access expressions can be chained to access nested data.</p>

<pre><code class="language-ruby">&gt; \e
story: {
  :name &quot;A Study in Scarlet&quot;
  :adaptations [
    {:year 1914 :media &quot;silent film&quot;}
    {:year 1968 :media &quot;television series&quot;}	
  ]
}
\e

{
  :adaptations [{
    :media &quot;silent film&quot;,
    :year 1914
  }, {
    :media &quot;television series&quot;,
    :year 1968
  }],
  :name &quot;A Study in Scarlet&quot;
}

&gt; story[:adaptations]
[{
  :media &quot;silent film&quot;,
  :year 1914
}, {
  :media &quot;television series&quot;,
  :year 1968
}]

&gt; story[:adaptations][1]
{
  :media &quot;television series&quot;,
  :year 1968
}
&gt; story[:adaptations][1][:media]
&quot;television series&quot;
</code></pre>

<p>Tweakflow supports placing the keys of chained access inside a single set of square brackets. The semantics are exactly the same as chaining container access.</p>

<pre><code class="language-ruby">&gt; story[:adaptations][1][:media]
&quot;television series&quot;

&gt; story[:adaptations 1 :media]
&quot;television series&quot;
</code></pre>

<p>It is worth noting that if the traversal yields <code>nil</code> at any intermediate point, the result is <code>nil</code>, which is consistent with <code>nil[x]</code> being <code>nil</code>.</p>

<pre><code class="language-ruby">&gt; story[:adaptations][4][:media] # there is no adaptation at index 4
nil

&gt; story[:adaptations 4 :media]
nil
</code></pre>

<p>The list of keys in the traversal form can be interspersed with splat expressions. The splat expression must be a list containing the keys to access. Each splat expression is expanded, and concatenated with any existing items just as in <a href="#list-literals">list literals</a>.</p>

<pre><code class="language-ruby">&gt; path: [:adaptations 1 :media]
[&quot;adaptations&quot;, 1, &quot;media&quot;]

&gt; story[...path]
&quot;television series&quot;

&gt; story[:adaptations ...[0 :year]]
1914

&gt; story[...[:adaptations] ...[1] ...[:year]]
1968
</code></pre>

<h4 id="function-calls">Function calls</h4>

<p>Function calls are notated by giving the function and following with round parentheses containing any arguments.</p>

<p>Function calls have the following formal structure:</p>

<pre><code class="language-text">functionCall
  :expression'('args')' 
  ;

args
  : ()
  | (positionalArg|namedArg|splatArg) (',' (positionalArg|namedArg|splatArg))*
  ;

positionalArg
  : expression
  ;

namedArg
  : identifier ':' expression
  ;

splatArg
  : '...' expression
  ;
</code></pre>

<p>A basic example defining a function, and calling it immediately:</p>

<pre><code class="language-ruby">&gt; ((x) -&gt; x*x)(2) # call with argument x=2
4
</code></pre>

<p>You can reference the function and call it:</p>

<pre><code class="language-ruby">&gt; f: (x) -&gt; x*x  # define a function and place it in f
function

&gt; f(2) # call function f
4

&gt; strings.length(&quot;foo&quot;) # call standard library function strings.length with one argument &quot;foo&quot;
3
</code></pre>

<p>For the purposes of further discussion, let&rsquo;s define function <code>f</code> as:</p>

<pre><code class="language-ruby">f: (long id = 0, string name = &quot;n/a&quot;) -&gt; string id .. &quot;-&quot; .. name
</code></pre>

<p>Above function has parameters <code>id</code> of type long and <code>name</code> of type string. Both have non-nil default values.</p>

<p>When calling a function it is possible to specify arguments values using position, name, or a mix of both.</p>

<h5 id="positional-arguments">Positional arguments</h5>

<p>Arguments given by position just list the values in parameter order and are seperated by comma. The following call passes <code>42</code> as <code>id</code> and <code>&quot;test&quot;</code> as <code>name</code>.</p>

<pre><code class="language-ruby">&gt; f(42, &quot;test&quot;)
&quot;42-test&quot;
</code></pre>

<p>Passing more than the declared number of positional arguments is an error.</p>

<pre><code class="language-ruby">&gt; f(42, &quot;test&quot;, &quot;too much&quot;)
ERROR: {
  :message &quot;cannot call function with 3 arguments&quot;,
  :code &quot;UNEXPECTED_ARGUMENT&quot;,
  ...
}
</code></pre>

<p>Passing less than the declared number of positional arguments results in the missing arguments being supplied through default values of the missing parameters. All parameters of a function have the default value <code>nil</code> unless explicitly specified in the function definition.</p>

<pre><code class="language-ruby">&gt; f(12)
&quot;12-n/a&quot;

&gt; f()
&quot;0-n/a&quot;

&gt; g: (x) -&gt; x # x's default value is nil
function

&gt; g(1) 
1

&gt; g() # x attains its default value nil
nil
</code></pre>

<h5 id="named-arguments">Named arguments</h5>

<p>When calling function, you can also pass arguments by name. Arguments given by name are listed in pairs of names and values separated by commas. The following call passes <code>42</code> as <code>id</code> and <code>&quot;test&quot;</code>  as <code>name</code> again, but uses named arguments this time. The order of named arguments does not matter.</p>

<pre><code class="language-ruby">&gt; f(id: 42, name: &quot;test&quot;)
&quot;42-test&quot;

&gt; f(name: &quot;test&quot;, id: 42)
&quot;42-test&quot;
</code></pre>

<p>Omitted arguments are assigned their default parameter value.</p>

<pre><code class="language-ruby">&gt; f(id: 42)
&quot;42-n/a&quot;

&gt; f(name: &quot;test&quot;)
&quot;0-test&quot;

&gt; f()
&quot;0-n/a&quot;
</code></pre>

<p>It is an error to supply argument names not present in function parameters:</p>

<pre><code class="language-ruby">&gt; f(id: 42, name: &quot;foo&quot;, country: &quot;US&quot;)
ERROR: {
  :message &quot;Function does not have parameter named: country&quot;,
  :code &quot;UNEXPECTED_ARGUMENT&quot;,
}
</code></pre>

<h5 id="mixed-positional-and-named-arguments">Mixed positional and named arguments</h5>

<p>Position and named arguments can be mixed in a single call. Positional arguments are listed first. Named arguments follow.</p>

<p>The following call passes <code>42</code> as <code>id</code> and <code>&quot;test&quot;</code>  as <code>name</code>. It mixes positional and named arguments.</p>

<pre><code class="language-ruby">&gt; f(42, name: &quot;test&quot;)
&quot;42-test&quot;
</code></pre>

<p>It is an error to supply any positional arguments after named arguments.</p>

<pre><code class="language-ruby">&gt; f(id: 42, &quot;test&quot;) # error, positional arguments cannot follow named arguments
ERROR: {
  :message &quot;Positional argument cannot follow named arguments.&quot;,
  :code &quot;UNEXPECTED_ARGUMENT&quot;,
  ...
}
</code></pre>

<p>It is possible to specify a parameter in both positional and named arguments. The rightmost specified value is used.</p>

<pre><code class="language-ruby">&gt; f(42, &quot;test&quot;, id: 7)
&quot;7-test&quot;

&gt; f(42, &quot;test&quot;, id: 7, id: 8)
&quot;8-test&quot;
</code></pre>

<p>Mixed style arguments are a useful idiom when a function exposes a set of leading arguments that have intuitive order, but allows for a set of less common option-style parameters to configure details.</p>

<p>The function <a href="/tweakflow/modules/std.html#add-period">add_period</a> from the standard library for example:</p>

<pre><code class="language-ruby">&gt; time.add_period(time.epoch, years: 1000)
2970-01-01T00:00:00Z@UTC

&gt; time.add_period(time.epoch, days: 2)
1970-01-03T00:00:00Z@UTC
</code></pre>

<h5 id="splat-arguments">Splat arguments</h5>

<p>Both positional arguments and named arguments can be supplied via a splat expression. This offers a notational convenience for cases where arguments have been collected into a list or dict.</p>

<p>Whenever positional arguments are allowed, and a splat expression evaluates to a list, the items from the list are used as positional arguments in order.</p>

<pre><code class="language-ruby">&gt; args: [42, &quot;name&quot;]
[42, &quot;name&quot;]

&gt; f(...args) # splat positional arguments
&quot;42-name&quot;
</code></pre>

<p>Positional arguments can be interspersed with splats. The resulting arguments are concatenated left to right:</p>

<pre><code class="language-ruby">&gt; f(42, ...[&quot;name&quot;]) 
&quot;42-name&quot;

&gt; f(...[42], &quot;name&quot;)
&quot;42-name&quot;

&gt; f(...[42], ...[&quot;name&quot;])
&quot;42-name&quot;
</code></pre>

<p>Whenever named arguments are allowed, and a splat expression evaluates to a dict, the items from the dict are used as named arguments.</p>

<p>Below example supplies the <code>id</code> and <code>name</code> named arguments.</p>

<pre><code class="language-ruby">&gt; person: {:id 42, :name &quot;test&quot;}
{
  :name &quot;test&quot;,
  :id 42
}
&gt; f(...person) # splat named arguments
&quot;42-test&quot;
</code></pre>

<p>Named arguments can be interspersed with splats. The resulting arguments dict is then merged left to right, with rightmost keys taking precedence in case of duplicates. Below example again effectively passes <code>42</code> as <code>id</code> and <code>&quot;test&quot;</code> as <code>name</code>.</p>

<pre><code class="language-ruby">&gt; person: {:id 0, :name &quot;test&quot;}
{
  :name &quot;test&quot;,
  :id 0
}
&gt; f(...person, id: 42)
&quot;42-test&quot;
</code></pre>

<p>Splats can be mixed as long as positional splats come first.</p>

<pre><code class="language-ruby">&gt; f(...[42, &quot;testing&quot;], ...{:name &quot;foo&quot;})
&quot;42-foo&quot;

&gt; f(...{:name &quot;foo&quot;}, ...[42, &quot;testing&quot;]) # no positional args allowed after named args
ERROR: {
  :message &quot;List splat provides positional arguments and cannot follow named arguments.&quot;,
  :code &quot;UNEXPECTED_ARGUMENT&quot;,
  ...
}
</code></pre>

<h5 id="argument-casting">Argument casting</h5>

<p>Arguments given in function calls are automatically cast to the declared parameter type:</p>

<pre><code class="language-ruby">&gt; f(&quot;3&quot;, 9837) # casts the first argument to long, and the second argument to string
&quot;3-9837&quot;

&gt; f(&quot;abc&quot;, &quot;def&quot;) # cannot cast first argument to long
ERROR: {
  :message &quot;Cannot cast abc to long&quot;,
  :code &quot;CAST_ERROR&quot;,
  ...
}
</code></pre>

<h5 id="return-value-casting">Return value casting</h5>

<p>Every function declares a return type. It is <code>any</code> by default. Every value a function returns is cast to the declared return type implicitly. If the return type of a function is <code>any</code>, the cast is not performed.</p>

<pre><code class="language-ruby">&gt; sum: (long x, long y) -&gt; long        x+y
function
&gt; sum_d: (long x, long y) -&gt; double    x+y
function
&gt; sum_s: (long x, long y) -&gt; string    x+y
function
&gt; id: (x) -&gt; x # return type is default: any
function

&gt; sum(1, 2)
3
&gt; sum_d(1, 2)
3.0
&gt; sum_s(1, 2)
&quot;3&quot;
&gt; id([])
[]
&gt; id(&quot;foo&quot;)
&quot;foo&quot;
</code></pre>

<h4 id="local-variables">Local variables</h4>

<p>Tweakflow allows defining local variables for holding temporary results. The <code>let</code> expression defines a set of variables that are bound in its scope, shadowing any existing local variables of the same name.</p>

<p>The formal syntax is as follows:</p>

<pre><code>'let' '{' varDef* '}' expression
</code></pre>

<p>All variables must be given values. Provided variables are only supported at the level of libraries.</p>

<p>Examples:</p>

<pre><code class="language-ruby">&gt; let {a: 1; b: 2} a + b
3

&gt; \e
  can_vote: (datetime born, datetime at) -&gt;
    let {
      age: time.years_between(born, at)
      is_eighteen: age &gt;= 18
    }
	is_eighteen
\e
function

&gt; can_vote(born: 1981-08-16T, at: 2016-11-02T)
true
&gt; can_vote(born: 1981-08-16T, at: 1999-11-02T)
true
&gt; can_vote(born: 1981-08-16T, at: 1998-11-02T)
false
</code></pre>

<h4 id="conditional-evaluation">Conditional evaluation</h4>

<p>TODO</p>

<h4 id="list-comprehensions">List comprehensions</h4>

<p>TODO</p>

<h4 id="pattern-matching">Pattern Matching</h4>

<p>TODO</p>

<h4 id="errors">Errors</h4>

<p>TODO</p>

<h5 id="throwing-errors">Throwing errors</h5>

<p>TODO</p>

<pre><code class="language-text">'throw' expression
</code></pre>

<p>Example</p>

<pre><code class="language-ruby">&gt; \e
add: (long x=0, long y=0, throw_on_overflow=true) -&gt;
  let {
    long sum: x + y
  }
  if throw_on_overflow
    if x &gt; 0 and y &gt; 0 and sum &lt;= 0 then throw {:code &quot;overflow&quot;, :message &quot;binary overflow adding #{x} and #{y}&quot;}
      if x &lt; 0 and y &lt; 0 and sum &gt;= 0 then throw {:code &quot;overflow&quot;, :message &quot;binary underflow adding #{x} and #{y}&quot;}
    sum
  else
    sum
\e
function

&gt; add(1, 2)
3

&gt; add(math.max_long, 1)
ERROR: {
  :code &quot;CUSTOM_ERROR&quot;,
  :value {
    :message &quot;binary overflow adding 9223372036854775807 and 1&quot;,
    :code &quot;overflow&quot;
  },
  ...
}        

&gt; add(math.min_long, -1)
ERROR: {
  :code &quot;CUSTOM_ERROR&quot;,
  :value {
    :message &quot;binary underflow adding -9223372036854775808 and -1&quot;,
    :code &quot;overflow&quot;
  },
  ...
}
</code></pre>

<h5 id="catching-errors">Catching errors</h5>

<p>Errors can be caught if they thrown inside a <code>try/catch</code> expression. The error value and stacktrace can each be bound to an identifier in the <code>catch</code> block.</p>

<pre><code class="language-text">tryCatch
  : 'try' expression 'catch' catchDeclaration expression
  ;

catchDeclaration
  :                               # catchAnonymous
  | identifier                    # catchError
  | identifier ',' identifier     # catchErrorAndTrace
  ;  
</code></pre>

<p>The whole try-catch block is an expression. It evaluates the expression in the try block, and if that does not throw, the result of that is the result of the try-catch block. If evaluation of the try block throws, then the error value and trace values are bound to the identifiers in order, if supplied, and the catch expression is evaluated. The result of that becomes the result of the try-catch block. If evaluation of the catch block throws, the error is propagated up.</p>

<pre><code class="language-ruby">&gt; \e 
# add two longs, revert to fallback_value if overflow or underflow happens
add_safe: (long x=0, long y=0, long fallback_value=0) -&gt; long
  try
    add(x, y)
  catch error
    if (error[:code] == &quot;overflow&quot;) # overflow?
      fallback_value
    else
      throw error # some other error, re-throw

\e
function
      
&gt; add_safe(1, 2)
3

&gt; add_safe(math.max_long, 1, fallback_value: nil)
nil
</code></pre>

<h4 id="references">References</h4>

<p>Expressions can reference variables available in scope. There are four levels of scope in general: local, library, module, and global. If a variable is referenced via its name, it is searched in the current scope and if not found, the search propagates upwards the scope chain. Global scope contains named modules only. Global names are visible from everywhere, but references must be prefixed with <code>$</code> to explicitly reference a name in global scope.</p>

<h5 id="unscoped-references">Unscoped references</h5>

<h5 id="library-scope-references">Library scope references</h5>

<p>Libraries define a set of variables in library local scope. The module and global scopes are visible as well.</p>

<h5 id="module-scope-references">Module scope references</h5>

<p>TODO</p>

<h5 id="global-scope-references">Global scope references</h5>

<p>TODO</p>

<p>Global scope only holds module names. To resolve a reference in global scope, the reference must be prepended with <code>$</code>. This is unambiguously referencing the global symbol name.</p>

<h5 id="module-names">Module names</h5>

<p>TODO</p>

<p>To skip the search chain and start resolving a reference in module scope, the reference can be prepended with <code>::</code>. This helps unambiguously referencing a namel in module scope, regardless of whether a name in a closer scope is shadowing it.</p>

<h4 id="operators">Operators</h4>

<p>TODO</p>

<p>Tweakflow features the following operators in precedence order.</p>

<p>All binary operators are left-associative.  Taking addition as an example <code>a + b + c</code> is evaluated as <code>(a + b) + c</code>.</p>

<p>Operators desugar to standard library calls. There are no special operator semantics, thus operator behavior is completely defined by the behaviour of standard library functions.</p>

<p>TODO: add parentheses for precedence grouping</p>

<table>
<thead>
<tr>
<th align="left">Operator</th>
<th align="left">Role</th>
<th align="left">Semantics</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left"><code>-a</code></td>
<td align="left">Negation</td>
<td align="left"><code>$std.math.negate(a)</code></td>
</tr>

<tr>
<td align="left"><code>!a</code></td>
<td align="left">Boolean not</td>
<td align="left"><code>$std.core.'not'(a)</code></td>
</tr>

<tr>
<td align="left"><code>not a</code></td>
<td align="left">Boolean not</td>
<td align="left"><code>$std.core.'not'(a)</code></td>
</tr>

<tr>
<td align="left"><code>a ** b</code></td>
<td align="left">Exponentiation</td>
<td align="left"><code>$std.math.power(a, b)</code></td>
</tr>

<tr>
<td align="left"><code>a * b</code></td>
<td align="left">Multiplication</td>
<td align="left"><code>$std.math.product([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a / b</code></td>
<td align="left">Division</td>
<td align="left"><code>$std.math.divide(a, b)</code></td>
</tr>

<tr>
<td align="left"><code>a // b</code></td>
<td align="left">Integer Division</td>
<td align="left"><code>$std.math.divide(a, b)</code></td>
</tr>

<tr>
<td align="left"><code>a % b</code></td>
<td align="left">Modulo</td>
<td align="left"><code>$std.math.modulo(a, b)</code></td>
</tr>

<tr>
<td align="left"><code>a + b</code></td>
<td align="left">Addition</td>
<td align="left"><code>$std.math.sum([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a - b</code></td>
<td align="left">Subtraction</td>
<td align="left"><code>$std.math.subtract(a, b)</code></td>
</tr>

<tr>
<td align="left"><code>a .. b</code></td>
<td align="left">String concatenation</td>
<td align="left"><code>$std.strings.concat([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a &lt; b</code></td>
<td align="left">Less than</td>
<td align="left"><code>$std.math.'&lt;'([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a &lt;= b</code></td>
<td align="left">Less than or equal</td>
<td align="left"><code>$std.math.'&lt;='([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a &gt; b</code></td>
<td align="left">Greater than</td>
<td align="left"><code>$std.math.'&gt;'([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a &gt;= b</code></td>
<td align="left">Greater than or equal</td>
<td align="left"><code>$std.math.'&gt;='([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a == b</code></td>
<td align="left">Equality</td>
<td align="left"><code>$std.core.'=='([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a != b</code></td>
<td align="left">Negated equality</td>
<td align="left"><code>$std.core.'not'($std.core.'=='([a, b]))</code></td>
</tr>

<tr>
<td align="left"><code>a &amp;&amp; b</code></td>
<td align="left">Boolean and</td>
<td align="left"><code>$std.core.'and'([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a and b</code></td>
<td align="left">Boolean and</td>
<td align="left"><code>$std.core.'and'([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a ¦¦ b</code></td>
<td align="left">Boolean or</td>
<td align="left"><code>$std.core.'or'([a, b])</code></td>
</tr>

<tr>
<td align="left"><code>a or b</code></td>
<td align="left">Boolean or</td>
<td align="left"><code>$std.core.'or'([a, b])</code></td>
</tr>
</tbody>
</table>

<h4 id="evaluation-precedence">Evaluation precedence</h4>

<p>TODO: give order of constructs and operators</p>

<h2 id="language-tools">Language tools</h2>

<h3 id="interactive-repl">Interactive REPL</h3>

<p>TODO: describe itf</p>

<h3 id="runner">Runner</h3>

<p>TODO: describe tf</p>

<h3 id="metadata-extraction">Metadata extraction</h3>

<p>TODO: describe tfdoc</p>

      </main>
    </div>
    
<footer>
  <div class="footer__copyright">
    © Twineworks 2017
  </div>
  <div class="footer__social"></div>
  <div class="footer__links">
    <a href="/tweakflow/legal_notice">Legal notice</a>
  </div>
</footer>

    
<script type="text/javascript" src="/tweakflow/js/vendor/jquery/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/tweakflow/js/vendor/waypoints/lib/jquery.waypoints.min.js"></script>
<script type="text/javascript" src="/tweakflow/js/vendor/waypoints/lib/shortcuts/sticky.js"></script>

<script type="text/javascript">window.noZensmooth = true;</script>
<script type="text/javascript" src="/tweakflow/js/vendor/zenscroll/zenscroll-min.js"></script>
<script type="text/javascript" src="/tweakflow/js/toc.js"></script>

</body>

</html>
